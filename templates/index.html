<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rastreador de Criptomoedas - Binance</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .alert-fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .pulse-alert { animation: pulse 2s infinite; }
        @keyframes pulse { 
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .gradient-bg { background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%); }
        .glass-effect { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); }
        .loading-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        .tradingview-widget-container iframe {
            width: 100% !important;
            height: 500px !important;
        }
    </style>
</head>
<body class="gradient-bg text-white min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-5xl font-bold bg-gradient-to-r from-green-400 to-blue-500 bg-clip-text text-transparent mb-3">
                <i class="fas fa-whale mr-3"></i>Rastreador de Criptomoedas
            </h1>
            <p class="text-gray-300 text-sm md:text-lg">Monitoramento avançado em tempo real - Binance API</p>
        </div>

        <!-- Controls -->
        <div class="glass-effect rounded-xl p-6 mb-8 border border-gray-700">
            <h2 class="text-xl md:text-2xl font-bold text-white mb-4">
                <i class="fas fa-cogs mr-2"></i>Configurações de Monitoramento
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        <i class="fas fa-chart-line mr-1"></i>Timeframe
                    </label>
                    <select id="timeframe" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-green-500">
                        {% for tf, config in TIMEFRAME_CONFIG.items() %}
                        <option value="{{ tf }}">{{ config.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        <i class="fas fa-chart-bar mr-1"></i>Múltiplo Mínimo
                    </label>
                    <select id="multiple" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-green-500">
                        <option value="2">2x</option>
                        <option value="3" selected>3x</option>
                        <option value="5">5x</option>
                        <option value="8">8x</option>
                        <option value="10">10x</option>
                        <option value="15">15x</option>
                        <option value="20">20x</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        <i class="fas fa-wave-square mr-1"></i>Configuração EMA
                    </label>
                    <select id="ema_type" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-green-500">
                        {% for ema_key, ema_config in EMA_CONFIGS.items() %}
                        <option value="{{ ema_key }}">{{ ema_config.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="lg:col-span-2 flex items-end space-x-3">
                    <button id="startBtn" class="flex-1 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105">
                        <i class="fas fa-play-circle mr-2"></i>Iniciar Monitoramento
                    </button>
                    <button id="stopBtn" class="flex-1 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105">
                        <i class="fas fa-stop-circle mr-2"></i>Parar Tudo
                    </button>
                </div>
            </div>
        </div>

        <!-- Status Panel -->
        <div id="status" class="glass-effect rounded-xl p-6 mb-8 border border-gray-700 hidden">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                <div class="flex items-center mb-4 lg:mb-0">
                    <div class="relative">
                        <div class="absolute -inset-1 bg-green-500 rounded-full blur opacity-75 animate-pulse"></div>
                        <div class="relative bg-green-600 rounded-full p-3">
                            <i class="fas fa-broadcast-tower text-white text-xl"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-xl font-bold text-green-400">Monitoramento Ativo</h3>
                        <p id="statusDetails" class="text-gray-300">Carregando símbolos...</p>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <div id="connectionStatus" class="flex items-center text-green-400">
                        <i class="fas fa-wifi text-2xl mr-2"></i>
                        <span class="font-semibold">Conectado</span>
                    </div>
                    <div class="flex items-center text-blue-400">
                        <i class="fas fa-microchip text-2xl mr-2"></i>
                        <span id="threadStatus" class="font-semibold">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Message -->
        <div id="loadingMessage" class="glass-effect rounded-xl p-8 mb-8 border border-green-500 text-center hidden">
            <div class="flex items-center justify-center space-x-4">
                <div class="loading-pulse text-green-400">
                    <i class="fas fa-sync-alt fa-2x"></i>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-green-400 mb-2">CARREGANDO SÍMBOLOS</h3>
                    <p class="text-gray-300">Inicializando monitoramento e aguardando primeiros alertas...</p>
                </div>
            </div>
        </div>

        <!-- TradingView Widget -->
        <div class="glass-effect rounded-xl p-6 border border-gray-700 mb-8">
            <h2 class="text-2xl font-bold text-white mb-6">
                <i class="fas fa-chart-line mr-2"></i>Gráfico em Tempo Real - BTC/USDT
            </h2>
            <!-- TradingView Widget BEGIN -->
            <div class="tradingview-widget-container" style="height: 500px; width: 100%;">
                <div id="tradingview_chart" style="height: 100%; width: 100%;"></div>
                <div class="tradingview-widget-copyright">
                    <a href="https://www.tradingview.com/" rel="noopener" target="_blank">
                        <span class="blue-text">Track all markets on TradingView</span>
                    </a>
                </div>
                <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
                <script type="text/javascript">
                    function initTradingViewChart() {
                        new TradingView.widget({
                            "autosize": true,
                            "symbol": "BINANCE:BTCUSDT",
                            "interval": "D",
                            "timezone": "America/Sao_Paulo",
                            "theme": "dark",
                            "style": "1",
                            "locale": "en",
                            "toolbar_bg": "#0F0F0F",
                            "enable_publishing": false,
                            "allow_symbol_change": true,
                            "container_id": "tradingview_chart",
                            "studies": [
                                "STD;DEMA"
                            ],
                            "backgroundColor": "#0F0F0F",
                            "gridColor": "rgba(242, 242, 242, 0.06)",
                            "hide_top_toolbar": false,
                            "hide_legend": false,
                            "save_image": false
                        });
                    }
                    
                    // Initialize when page loads
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', initTradingViewChart);
                    } else {
                        initTradingViewChart();
                    }
                </script>
            </div>
            <!-- TradingView Widget END -->
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
            <!-- Volume Alerts -->
            <div class="xl:col-span-2">
                <div class="glass-effect rounded-xl p-6 border border-gray-700 h-full">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-yellow-400">
                            <i class="fas fa-chart-bar mr-2"></i>Alertas de Volume
                        </h2>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-400">Whales Detectados:</span>
                            <span id="volumeAlertsLive" class="text-2xl font-bold text-yellow-400">0</span>
                        </div>
                    </div>
                    <div id="volumeAlerts" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
                        <div class="text-gray-500 text-center py-8">
                            <i class="fas fa-search fa-3x mb-4 opacity-50"></i>
                            <p class="text-lg">Aguardando detecção de whales...</p>
                            <p class="text-sm text-gray-400 mt-2">Volume anômalo será exibido aqui</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Indicator Alerts -->
            <div class="xl:col-span-1">
                <div class="glass-effect rounded-xl p-6 border border-gray-700 h-full">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-blue-400">
                            <i class="fas fa-chart-line mr-2"></i>Sinais Técnicos
                        </h2>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-400">Sinais:</span>
                            <span id="indicatorAlertsLive" class="text-2xl font-bold text-blue-400">0</span>
                        </div>
                    </div>
                    <div id="indicatorAlerts" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
                        <div class="text-gray-500 text-center py-8">
                            <i class="fas fa-wave-square fa-3x mb-4 opacity-50"></i>
                            <p class="text-lg">Aguardando sinais técnicos...</p>
                            <p class="text-sm text-gray-400 mt-2">RSI, EMA e MACD serão exibidos aqui</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert History -->
        <div class="glass-effect rounded-xl p-6 border border-gray-700 mt-8">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
                <h2 class="text-2xl font-bold text-white mb-4 sm:mb-0">
                    <i class="fas fa-history mr-2"></i>Histórico de Alertas
                </h2>
                <div class="flex flex-wrap gap-2">
                    <button id="showAllAlerts" class="px-3 py-2 bg-blue-600 rounded-lg text-white font-semibold hover:bg-blue-700 transition text-sm">Todos</button>
                    <button id="showVolumeAlerts" class="px-3 py-2 bg-yellow-600 rounded-lg text-white font-semibold hover:bg-yellow-700 transition text-sm">Volume</button>
                    <button id="showIndicatorAlerts" class="px-3 py-2 bg-green-600 rounded-lg text-white font-semibold hover:bg-green-700 transition text-sm">Indicadores</button>
                </div>
            </div>
            <div id="alertHistory" class="max-h-96 overflow-y-auto space-y-3">
                <div class="text-gray-500 text-center py-8">
                    <i class="fas fa-clock fa-3x mb-4 opacity-50"></i>
                    <p>Nenhum alerta no histórico</p>
                </div>
            </div>
        </div>

        <!-- Advanced Stats -->
        <div class="glass-effect rounded-xl p-6 border border-gray-700 mt-8">
            <h2 class="text-2xl font-bold text-white mb-6">
                <i class="fas fa-chart-pie mr-2"></i>Estatísticas Avançadas
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-400" id="totalCycles">0</div>
                    <div class="text-gray-400 text-sm">Ciclos Concluídos</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-400" id="totalProcessed">0</div>
                    <div class="text-gray-400 text-sm">Símbolos Processados</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-yellow-400" id="totalVolumeAlerts">0</div>
                    <div class="text-gray-400 text-sm">Total Alertas Volume</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-purple-400" id="totalIndicatorAlerts">0</div>
                    <div class="text-gray-400 text-sm">Total Alertas Indicadores</div>
                </div>
            </div>
        </div>

        <!-- Stats Dashboard -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8 mt-8">
            <div class="glass-effect rounded-xl p-4 border border-gray-700 text-center transform hover:scale-105 transition duration-200">
                <div class="text-xl md:text-3xl font-bold text-green-400 mb-2" id="totalSymbols">0</div>
                <div class="text-gray-400 text-xs md:text-sm uppercase tracking-wider">Símbolos</div>
                <div class="text-xs text-gray-500 mt-1">Ativos Monitorados</div>
            </div>
            <div class="glass-effect rounded-xl p-4 border border-gray-700 text-center transform hover:scale-105 transition duration-200">
                <div class="text-xl md:text-3xl font-bold text-yellow-400 mb-2" id="volumeAlertsCount">0</div>
                <div class="text-gray-400 text-xs md:text-sm uppercase tracking-wider">Volume</div>
                <div class="text-xs text-gray-500 mt-1">Alertas de Whale</div>
            </div>
            <div class="glass-effect rounded-xl p-4 border border-gray-700 text-center transform hover:scale-105 transition duration-200">
                <div class="text-xl md:text-3xl font-bold text-blue-400 mb-2" id="indicatorAlertsCount">0</div>
                <div class="text-gray-400 text-xs md:text-sm uppercase tracking-wider">Indicadores</div>
                <div class="text-xs text-gray-500 mt-1">Sinais Técnicos</div>
            </div>
            <div class="glass-effect rounded-xl p-4 border border-gray-700 text-center transform hover:scale-105 transition duration-200">
                <div class="text-xl md:text-3xl font-bold text-purple-400 mb-2" id="lastUpdate">-</div>
                <div class="text-gray-400 text-xs md:text-sm uppercase tracking-wider">Atualização</div>
                <div class="text-xs text-gray-500 mt-1">Última Verificação</div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-12 text-gray-500">
            <p>Mykey Pro &copy; 2025 - Monitoramento em tempo real da Binance</p>
            <p class="text-sm mt-2">Desenvolvido para análise técnica avançada e detecção de whales</p>
        </div>
    </div>

    <script>
        const socket = io();
        let volumeAlertCount = 0;
        let indicatorAlertCount = 0;
        let totalVolumeAlerts = 0;
        let totalIndicatorAlerts = 0;
        let alertHistory = [];
        let isFirstAlert = true;
        let currentFilter = 'all';

        // Elements
        const elements = {
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            statusDiv: document.getElementById('status'),
            statusDetails: document.getElementById('statusDetails'),
            volumeAlertsDiv: document.getElementById('volumeAlerts'),
            indicatorAlertsDiv: document.getElementById('indicatorAlerts'),
            volumeAlertsLive: document.getElementById('volumeAlertsLive'),
            indicatorAlertsLive: document.getElementById('indicatorAlertsLive'),
            totalSymbolsSpan: document.getElementById('totalSymbols'),
            volumeAlertsCountSpan: document.getElementById('volumeAlertsCount'),
            indicatorAlertsCountSpan: document.getElementById('indicatorAlertsCount'),
            lastUpdateSpan: document.getElementById('lastUpdate'),
            totalCyclesSpan: document.getElementById('totalCycles'),
            totalProcessedSpan: document.getElementById('totalProcessed'),
            totalVolumeAlertsSpan: document.getElementById('totalVolumeAlerts'),
            totalIndicatorAlertsSpan: document.getElementById('totalIndicatorAlerts'),
            alertHistoryDiv: document.getElementById('alertHistory'),
            threadStatus: document.getElementById('threadStatus'),
            loadingMessage: document.getElementById('loadingMessage')
        };

        // Start monitoring
        elements.startBtn.addEventListener('click', () => {
            const timeframe = document.getElementById('timeframe').value;
            const multiple = document.getElementById('multiple').value;
            const emaType = document.getElementById('ema_type').value;

            // Clear current alerts and show loading
            clearCurrentAlerts();
            showLoadingMessage();
            isFirstAlert = true;

            fetch('/start_monitoring', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `timeframe=${timeframe}&multiple=${multiple}&ema_type=${emaType}`
            }).then(response => response.text()).then(data => {
                console.log('Monitoramento iniciado:', data);
                showNotification('Monitoramento iniciado!', 'success');
                
                // Update status with actual values
                updateStatusWithValues(timeframe, multiple, emaType);
            }).catch(error => {
                console.error('Erro:', error);
                showNotification('Erro ao iniciar monitoramento', 'error');
                hideLoadingMessage();
            });
        });

        // Update status with actual values
        function updateStatusWithValues(timeframe, multiple, emaType) {
            const timeframeSelect = document.getElementById('timeframe');
            const multipleSelect = document.getElementById('multiple');
            const emaSelect = document.getElementById('ema_type');
            
            const timeframeText = timeframeSelect.options[timeframeSelect.selectedIndex].text;
            const multipleText = multipleSelect.options[multipleSelect.selectedIndex].text;
            const emaText = emaSelect.options[emaSelect.selectedIndex].text;
            
            elements.statusDetails.innerHTML = `
                <strong>Timeframe:</strong> ${timeframeText} | 
                <strong>Múltiplo:</strong> ${multipleText} | 
                <strong>EMA:</strong> ${emaText} |
                <strong>Símbolos:</strong> Carregando...
            `;
        }

        // Stop monitoring
        elements.stopBtn.addEventListener('click', () => {
            fetch('/stop_monitoring', {method: 'POST'})
            .then(response => response.text())
            .then(data => {
                console.log('Parado:', data);
                showNotification('Monitoramento parado!', 'warning');
                hideLoadingMessage();
            })
            .catch(error => {
                console.error('Erro:', error);
                showNotification('Erro ao parar monitoramento', 'error');
            });
        });

        // Filter alerts
        document.getElementById('showAllAlerts').addEventListener('click', () => filterAlerts('all'));
        document.getElementById('showVolumeAlerts').addEventListener('click', () => filterAlerts('volume'));
        document.getElementById('showIndicatorAlerts').addEventListener('click', () => filterAlerts('indicator'));

        // Socket event handlers
        socket.on('connect', () => {
            console.log('Conectado ao servidor');
            updateConnectionStatus(true);
        });

        socket.on('disconnect', () => {
            console.log('Desconectado do servidor');
            updateConnectionStatus(false);
        });

        socket.on('monitoring_started', (data) => {
            showStatus(data);
            elements.threadStatus.textContent = `Thread ${data.thread_id}`;
            showNotification(`Monitoramento iniciado: ${data.timeframe} ${data.multiple}x`, 'success');
        });

        socket.on('monitoring_stopped', (data) => {
            hideStatus();
            elements.threadStatus.textContent = '-';
            showNotification('Monitoramento parado', 'warning');
        });

        socket.on('volume_alert', (alert) => {
            if (isFirstAlert) {
                hideLoadingMessage();
                isFirstAlert = false;
            }
            
            volumeAlertCount++;
            totalVolumeAlerts++;
            addVolumeAlert(alert);
            addToHistory(alert, 'volume');
            updateStats();
            playNotificationSound();
            showNotification(`🚨 Volume ${alert.crypto}: ${alert.volume_ratio}x`, 'warning');
        });

        socket.on('indicator_alert', (alert) => {
            if (isFirstAlert) {
                hideLoadingMessage();
                isFirstAlert = false;
            }
            
            indicatorAlertCount++;
            totalIndicatorAlerts++;
            addIndicatorAlert(alert);
            addToHistory(alert, 'indicator');
            updateStats();
            playNotificationSound();
            
            let message = '';
            if (alert.type.includes('RSI')) {
                message = `📊 RSI ${alert.crypto}: ${alert.current_rsi}`;
            } else if (alert.type.includes('EMA')) {
                message = `📈 ${alert.type.replace(/_/g, ' ')} ${alert.crypto}`;
            } else if (alert.type.includes('MACD')) {
                message = `📉 ${alert.type.replace(/_/g, ' ')} ${alert.crypto}`;
            } else {
                message = `📈 ${alert.type} ${alert.crypto}`;
            }
            showNotification(message, 'info');
        });

        socket.on('stats_update', (data) => {
            updateAdvancedStats(data);
        });

        socket.on('status_update', (data) => {
            if (data.monitoring_active) {
                showStatus(data);
                elements.threadStatus.textContent = `Thread ${data.current_thread_id}`;
            }
        });

        // Helper functions
        function showStatus(data) {
            elements.statusDiv.classList.remove('hidden');
            const symbolsCount = data.total_symbols || 'Carregando...';
            const timeframe = data.current_timeframe || document.getElementById('timeframe').options[document.getElementById('timeframe').selectedIndex].text;
            const multiple = data.current_multiple || document.getElementById('multiple').options[document.getElementById('multiple').selectedIndex].text;
            const emaName = data.current_ema_name || document.getElementById('ema_type').options[document.getElementById('ema_type').selectedIndex].text;
            
            elements.statusDetails.innerHTML = `
                <strong>Timeframe:</strong> ${timeframe} | 
                <strong>Múltiplo:</strong> ${multiple} | 
                <strong>EMA:</strong> ${emaName} |
                <strong>Símbolos:</strong> ${symbolsCount}
            `;
            elements.totalSymbolsSpan.textContent = symbolsCount;
        }

        function hideStatus() {
            elements.statusDiv.classList.add('hidden');
        }

        function showLoadingMessage() {
            elements.loadingMessage.classList.remove('hidden');
        }

        function hideLoadingMessage() {
            elements.loadingMessage.classList.add('hidden');
        }

        function clearCurrentAlerts() {
            // Move current alerts to history before clearing
            const currentVolumeAlerts = Array.from(elements.volumeAlertsDiv.children)
                .filter(el => !el.className.includes('text-gray-500'))
                .map(el => {
                    const crypto = el.querySelector('.font-bold')?.textContent || 'Unknown';
                    const multiple = el.querySelector('.bg-yellow-600')?.textContent || '0x';
                    return { type: 'volume', crypto, multiple, timestamp: new Date().toLocaleTimeString() };
                });

            const currentIndicatorAlerts = Array.from(elements.indicatorAlertsDiv.children)
                .filter(el => !el.className.includes('text-gray-500'))
                .map(el => {
                    const crypto = el.querySelector('.font-bold')?.textContent || 'Unknown';
                    const alertType = el.querySelector('.bg-green-600, .bg-red-600')?.textContent || 'Indicator';
                    return { type: 'indicator', crypto, alertType, timestamp: new Date().toLocaleTimeString() };
                });

            // Add to history
            currentVolumeAlerts.forEach(alert => addToHistory(alert, 'volume'));
            currentIndicatorAlerts.forEach(alert => addToHistory(alert, 'indicator'));

            // Clear current displays
            elements.volumeAlertsDiv.innerHTML = `
                <div class="text-gray-500 text-center py-8">
                    <i class="fas fa-search fa-3x mb-4 opacity-50"></i>
                    <p class="text-lg">Aguardando detecção de whales...</p>
                    <p class="text-sm text-gray-400 mt-2">Volume anômalo será exibido aqui</p>
                </div>
            `;

            elements.indicatorAlertsDiv.innerHTML = `
                <div class="text-gray-500 text-center py-8">
                    <i class="fas fa-wave-square fa-3x mb-4 opacity-50"></i>
                    <p class="text-lg">Aguardando sinais técnicos...</p>
                    <p class="text-sm text-gray-400 mt-2">RSI, EMA e MACD serão exibidos aqui</p>
                </div>
            `;

            // Reset counters
            volumeAlertCount = 0;
            indicatorAlertCount = 0;
            updateStats();
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.innerHTML = '<i class="fas fa-wifi text-2xl mr-2"></i><span class="font-semibold text-green-400">Conectado</span>';
            } else {
                statusElement.innerHTML = '<i class="fas fa-wifi text-2xl mr-2"></i><span class="font-semibold text-red-400">Desconectado</span>';
            }
        }

        function addVolumeAlert(alert) {
            const alertElement = createAlertElement(alert, 'volume');
            
            if (elements.volumeAlertsDiv.firstChild?.className?.includes('text-gray-500')) {
                elements.volumeAlertsDiv.innerHTML = '';
            }
            elements.volumeAlertsDiv.insertBefore(alertElement, elements.volumeAlertsDiv.firstChild);

            if (elements.volumeAlertsDiv.children.length > 15) {
                elements.volumeAlertsDiv.removeChild(elements.volumeAlertsDiv.lastChild);
            }
            
            elements.volumeAlertsLive.textContent = volumeAlertCount;
        }

        function addIndicatorAlert(alert) {
            const alertElement = createAlertElement(alert, 'indicator');
            
            if (elements.indicatorAlertsDiv.firstChild?.className?.includes('text-gray-500')) {
                elements.indicatorAlertsDiv.innerHTML = '';
            }
            elements.indicatorAlertsDiv.insertBefore(alertElement, elements.indicatorAlertsDiv.firstChild);

            if (elements.indicatorAlertsDiv.children.length > 15) {
                elements.indicatorAlertsDiv.removeChild(elements.indicatorAlertsDiv.lastChild);
            }
            
            elements.indicatorAlertsLive.textContent = indicatorAlertCount;
        }

        function createAlertElement(alert, type) {
            const isVolume = type === 'volume';
            const color = alert.color || (isVolume ? 'yellow' : 
                          alert.type.includes('GOLDEN') || alert.type.includes('BULLISH') || alert.type.includes('OVERSOLD') ? 'green' : 'red');
            
            const alertElement = document.createElement('div');
            alertElement.className = `alert-fade-in bg-${color}-900 border-l-4 border-${color}-500 p-4 rounded-lg`;
            
            let content = '';
            
            if (isVolume) {
                content = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <div class="font-bold text-${color}-300 text-xl mr-3">${alert.crypto}</div>
                                <span class="bg-${color}-600 text-white px-2 py-1 rounded text-sm font-bold">${alert.volume_ratio}x</span>
                            </div>
                            <div class="text-${color}-200 text-sm mb-1">
                                <strong>Volume Atual:</strong> ${alert.current_volume_formatted} | 
                                <strong>Média:</strong> ${alert.average_volume_formatted}
                            </div>
                            <div class="text-gray-300 text-xs">
                                <strong>Preço:</strong> $${alert.price} | 
                                <span class="text-${alert.price_change >= 0 ? 'green' : 'red'}-400 font-bold">
                                    ${alert.price_change >= 0 ? '↗' : '↘'} ${alert.price_change}%
                                </span>
                            </div>
                        </div>
                        <div class="text-right ml-4">
                            <div class="text-${color}-400 font-bold text-lg">${alert.volume_ratio}x</div>
                            <div class="text-gray-400 text-xs mt-1">${alert.timestamp.split(' ')[1]}</div>
                        </div>
                    </div>
                    <div class="text-gray-400 text-xs mt-2 flex justify-between">
                        <span>${alert.timeframe_name}</span>
                        <span class="text-${color}-400">${alert.alert_description || 'WHALE DETECTED'}</span>
                    </div>
                `;
            } else {
                let details = '';
                if (alert.type.includes('RSI')) {
                    details = `<strong>RSI:</strong> ${alert.previous_rsi} → ${alert.current_rsi}`;
                } else if (alert.type.includes('EMA')) {
                    details = `<strong>${alert.ema_name}:</strong> ${alert.ema_fast}/${alert.ema_slow}`;
                } else if (alert.type.includes('MACD')) {
                    details = `<strong>MACD:</strong> ${alert.macd_line?.toFixed(6) || ''} | <strong>Signal:</strong> ${alert.signal_line?.toFixed(6) || ''} | <strong>Histogram:</strong> ${alert.macd_histogram?.toFixed(6) || ''}`;
                }
                
                content = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <div class="font-bold text-${color}-300 text-xl mr-3">${alert.crypto}</div>
                                <span class="bg-${color}-600 text-white px-2 py-1 rounded text-sm font-bold">${alert.type.replace(/_/g, ' ')}</span>
                            </div>
                            <div class="text-${color}-200 text-sm mb-1">${alert.type.replace(/_/g, ' ')}</div>
                            <div class="text-gray-300 text-xs">${details}</div>
                            ${alert.ema_name ? `<div class="text-gray-400 text-xs mt-1">${alert.ema_name}</div>` : ''}
                        </div>
                        <div class="text-right ml-4">
                            <div class="text-${color}-400 font-bold text-lg">${alert.type.split('_')[0]}</div>
                            <div class="text-gray-400 text-xs mt-1">${alert.timestamp.split(' ')[1]}</div>
                        </div>
                    </div>
                    <div class="text-gray-400 text-xs mt-2">${alert.timeframe_name}</div>
                `;
            }
            
            alertElement.innerHTML = content;
            return alertElement;
        }

        function addToHistory(alert, type) {
            alert.historyType = type;
            alert.historyId = Date.now();
            alertHistory.unshift(alert);
            
            if (alertHistory.length > 100) {
                alertHistory = alertHistory.slice(0, 100);
            }
            
            updateAlertHistory();
        }

        function updateAlertHistory() {
            const filteredAlerts = alertHistory.filter(alert => {
                if (currentFilter === 'all') return true;
                if (currentFilter === 'volume') return alert.historyType === 'volume';
                if (currentFilter === 'indicator') return alert.historyType === 'indicator';
                return true;
            });

            if (filteredAlerts.length === 0) {
                elements.alertHistoryDiv.innerHTML = `
                    <div class="text-gray-500 text-center py-8">
                        <i class="fas fa-clock fa-3x mb-4 opacity-50"></i>
                        <p>Nenhum alerta no histórico</p>
                    </div>
                `;
                return;
            }
            
            elements.alertHistoryDiv.innerHTML = '';
            
            filteredAlerts.forEach(alert => {
                const historyElement = document.createElement('div');
                const color = alert.color || (alert.historyType === 'volume' ? 'yellow' : 'blue');
                
                historyElement.className = `bg-gray-800 border-l-4 border-${color}-500 p-4 rounded-lg mb-3`;
                
                const time = alert.timestamp;
                const typeIcon = alert.historyType === 'volume' ? '📊' : '📈';
                const typeText = alert.historyType === 'volume' ? 'Volume' : 'Indicador';
                
                let details = '';
                if (alert.historyType === 'volume') {
                    details = `
                        <div class="text-yellow-400 text-sm">
                            <strong>Volume:</strong> ${alert.current_volume_formatted} | 
                            <strong>Múltiplo:</strong> ${alert.volume_ratio}x
                        </div>
                        <div class="text-gray-300 text-xs">
                            <strong>Preço:</strong> $${alert.price} | 
                            <span class="text-${alert.price_change >= 0 ? 'green' : 'red'}-400">
                                ${alert.price_change >= 0 ? '↗' : '↘'} ${alert.price_change}%
                            </span>
                        </div>
                    `;
                } else {
                    if (alert.type.includes('RSI')) {
                        details = `<div class="text-blue-400 text-sm"><strong>RSI:</strong> ${alert.current_rsi}</div>`;
                    } else if (alert.type.includes('EMA')) {
                        details = `
                            <div class="text-blue-400 text-sm">
                                <strong>${alert.ema_name}:</strong> Fast ${alert.ema_fast} | Slow ${alert.ema_slow}
                            </div>
                        `;
                    } else if (alert.type.includes('MACD')) {
                        details = `
                            <div class="text-blue-400 text-sm">
                                <strong>MACD:</strong> ${alert.macd_line?.toFixed(6) || ''} | 
                                <strong>Signal:</strong> ${alert.signal_line?.toFixed(6) || ''} | 
                                <strong>Histogram:</strong> ${alert.macd_histogram?.toFixed(6) || ''}
                            </div>
                        `;
                    }
                }
                
                historyElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center">
                            <span class="text-2xl mr-2">${typeIcon}</span>
                            <div>
                                <span class="font-bold text-white text-lg">${alert.crypto}</span>
                                <span class="text-sm text-gray-400 ml-2">${typeText}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-400">${time}</div>
                            <div class="text-xs text-gray-500">${alert.timeframe_name}</div>
                        </div>
                    </div>
                    ${details}
                    ${alert.alert_description ? `<div class="text-gray-400 text-xs mt-2">${alert.alert_description}</div>` : ''}
                `;
                
                elements.alertHistoryDiv.appendChild(historyElement);
            });
        }

        function filterAlerts(filter) {
            currentFilter = filter;
            updateAlertHistory();
            
            // Update button styles
            document.getElementById('showAllAlerts').classList.remove('bg-blue-700');
            document.getElementById('showVolumeAlerts').classList.remove('bg-yellow-700');
            document.getElementById('showIndicatorAlerts').classList.remove('bg-green-700');
            
            document.getElementById('showAllAlerts').classList.add('bg-blue-600');
            document.getElementById('showVolumeAlerts').classList.add('bg-yellow-600');
            document.getElementById('showIndicatorAlerts').classList.add('bg-green-600');
            
            document.getElementById(`show${filter.charAt(0).toUpperCase() + filter.slice(1)}Alerts`).classList.remove(`bg-${filter === 'all' ? 'blue' : filter === 'volume' ? 'yellow' : 'green'}-600`);
            document.getElementById(`show${filter.charAt(0).toUpperCase() + filter.slice(1)}Alerts`).classList.add(`bg-${filter === 'all' ? 'blue' : filter === 'volume' ? 'yellow' : 'green'}-700`);
        }

        function formatNumber(num) {
            if (!num) return '0';
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
            return num.toFixed(2);
        }

        function updateStats() {
            elements.volumeAlertsCountSpan.textContent = volumeAlertCount;
            elements.indicatorAlertsCountSpan.textContent = indicatorAlertCount;
            elements.lastUpdateSpan.textContent = new Date().toLocaleTimeString();
        }

        function updateAdvancedStats(data) {
            elements.totalCyclesSpan.textContent = data.cycle || 0;
            elements.totalProcessedSpan.textContent = data.processed || 0;
            elements.totalVolumeAlertsSpan.textContent = data.total_alerts?.volume_alerts || 0;
            elements.totalIndicatorAlertsSpan.textContent = 
                (data.total_alerts?.rsi_alerts || 0) + 
                (data.total_alerts?.ema_alerts || 0) + 
                (data.total_alerts?.macd_alerts || 0);
        }

        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('Audio não suportado');
            }
        }

        function showNotification(message, type) {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300 ${
                type === 'success' ? 'bg-green-600' : 
                type === 'error' ? 'bg-red-600' : 
                type === 'warning' ? 'bg-yellow-600' : 'bg-blue-600'
            } text-white`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Initial setup
        updateStats();
        filterAlerts('all');
        
        // Load initial stats
        fetch('/status')
            .then(response => response.json())
            .then(data => {
                elements.totalSymbolsSpan.textContent = data.total_symbols || 0;
                if (data.monitoring_active) {
                    showStatus(data);
                    elements.threadStatus.textContent = `Thread ${data.current_thread_id || '-'}`;
                }
            })
            .catch(error => {
                console.error('Erro ao carregar status:', error);
            });

        // Load alert history
        fetch('/alerts')
            .then(response => response.json())
            .then(data => {
                alertHistory = data.slice(0, 100).map(alert => ({
                    ...alert,
                    historyType: alert.type?.includes('VOLUME') ? 'volume' : 'indicator'
                }));
                updateAlertHistory();
            })
            .catch(error => {
                console.error('Erro ao carregar histórico:', error);
            });

        // Request current status
        socket.emit('request_status');
    </script>
</body>
</html>